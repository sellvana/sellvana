<!--{ label: Reviews }-->
<!--{ pos: 10 }-->
{% set m = THIS.get('model') %}
{% set promo = APP.instance('FCom_Promo_Model_Promo') %}
{% set validator = THIS.get('validator') %}
{% set labelClass = "col-md-3" %}

{% import THIS.view('core/form-elements').twigName() as forms %}

{% if APP.m('FCom_CustomerGroups').run_status == 'LOADED' %}
    {% set customerGroups = APP.instance('FCom_CustomerGroups_Model_Group').groupsOptions() %}
{% endif %}

{% if APP.m('FCom_MultiSite').run_status == 'LOADED' %}
    {% set sites = APP.instance('FCom_MultiSite_Model_Site').siteOptions() %}
{% endif %}

<fieldset class="adm-section-group">
    <div class="f-section">
        {{ forms.input({label: 'Admin Summary'|_, required: 1, name: "model[admin_summary]",
            value: validator.fieldValue('admin_summary'), label_class: labelClass,
            id: "model-admin_summary", help_icon: 1, help_text: 'Admin Summary'|_ }) }}
        {{ forms.textarea({label: 'Internal Notes'|_, name: "model[admin_notes]",
            value: validator.fieldValue('admin_notes'),label_class: labelClass,
            id: "model-admin_notes", help_icon: 1, help_text: 'Internal Notes'|_ }) }}
        {{ forms.input({label: 'Customer Label'|_, required: 1, name: "model[customer_label]",
            value: validator.fieldValue('customer_label'),label_class: labelClass,
            id: "model-customer_label", help_icon: 1, help_text: 'Customer Label'|_ }) }}
        {{ forms.textarea({label: 'Details for Customers'|_, name: "model[customer_details]",
            value: validator.fieldValue('customer_details'),label_class: labelClass,
            id: "model-customer_details", help_icon: 1, help_text: 'Details for Customers'|_ }) }}

        {{ forms.select({
            label: 'Status'|_,label_class: labelClass,
            name: "model[status]",
            value: validator.fieldValue('status'),
            id: "model-status", help_icon: 1,
            help_text: "Promotion status"|_,
            select2: 1, options: ['Pending'|_, 'Active'|_, 'Expired'|_],
            input_div_class: "col-md-2"
        }) }}


        {{ forms.input({label: 'Date Range'|_, required: 1, name: "model[date_range]",
            value: validator.fieldValue('date_range'),label_class: labelClass,
            id: "model-date_range", help_icon: 1, help_text: 'Date Range'|_ }) }}
        <div id="testbed"></div>
        <script type="text/javascript">
            require(['jquery', 'moment', 'daterangepicker', 'bootstrap'], function ($) {
                var startDate = new Date();
                var s = startDate.getFullYear() + '-' + (startDate.getMonth() + 1) + '-' + startDate.getDate();
                $('#model-date_range').daterangepicker(
                    {
                        format: 'YYYY-MM-DD',
                        startDate: s
                    }
                );
                var $help = $('.help-icon');
                $help.popover({placement: 'auto', trigger: 'hover focus'});
                $help.on('click', function (e) {
                    e.preventDefault();
                });
            });

//            require(['react', 'jsx!fcom.promo'], function(React, Promo) {
//                Promo.createGrid();
//                console.log(Promo);
//            })
        </script>
        {{ forms.select({
            label: "Coupon Code Enter For Validity"|_,label_class: labelClass,
            name: "model[use_coupon]",
            value: validator.fieldValue("use_coupon"),
            id: "model-use_coupon", help_icon: 1,
            help_text: "Require coupon code"|_,
            select2: 1, options: ["No coupon code required"|_, "Single coupon code"|_, "Multiple coupon codes"|_]
        }) }}
        <div id="coupon-options"></div>
        <div class="form-group">
            {{ forms.hidden({field:"conditions_serialized", value: validator.fieldValue("conditions_serialized")}) }}
            <label class="control-label col-md-3" for="model-conditions">{{"Conditions"|_}}&nbsp;
                    <a id="help-model-conditions" class="pull-right help-icon" href="#"
                       data-toggle="popover" data-trigger="focus" data-content="{{"Configure conditions"|_}}"
                       data-container="body">
                        <span class="glyphicon glyphicon-question-sign"></span></a>
            </label>
            <div class="col-md-4">
                <select id="model-conditions" name="model[conditions]" class="form-control to-select2">
                    <option value="0">{{"All Conditions Have to Match"|_}}</option>
                    <option value="1">{{"Any Condition Has to Match"|_}}</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="model-conditions_type" class="sr-only">{{ "Condition type"|_ }}</label>
                <select id="model-conditions_type" name="model[conditions_type]" class="form-control to-select2">
                    <option value="-1">{{ "Add Condition Type..."|_ }}</option>
                    <option value="skus">{{ "Products"|_ }}</option>
                    <option value="cats">{{ "Categories"|_ }}</option>
                    <option value="total">{{ "Cart Total"|_ }}</option>
                    <option value="comb">{{ "Combination"|_ }}</option>
                    <option value="shipping">{{ "Shipping Destination"|_ }}</option>
                </select>
            </div>
            <div class="col-md-1">
                <button class="btn btn-link" type="button" id="condition_action_add">
                    <span aria-hidden="true" class="glyphicon glyphicon glyphicon-plus-sign"></span>
                </button>
            </div>
        </div>
        <div id="conditions-options"></div>

        <div class="form-group">
            {{ forms.hidden({field:"actions_serialized", value: validator.fieldValue("actions_serialized")}) }}
            <label class="control-label col-md-3" for="model-actions">{{"Add Promo Actions"|_}}&nbsp;
                    <a id="help-model-actions" class="pull-right help-icon" href="#"
                       data-toggle="popover" data-trigger="focus" data-content="{{"Configure promo actions"|_}}"
                       data-container="body">
                        <span class="glyphicon glyphicon-question-sign"></span></a>
            </label>
            <div class="col-md-4">
                <select id="model-actions" name="model[actions]" class="form-control to-select2">
                    <option value="">{{"Add Promo Action..."|_}}</option>
                    <option value="get_discount">{{"Discount"|_}}</option>
                    <option value="get_shipping">{{"Shipping"|_}}</option>
                    <option value="get_products">{{"Free Products"|_}}</option>
                </select>
            </div>
            <div class="col-md-1">
                <button class="btn btn-link" type="button" id="action_add">
                    <span aria-hidden="true" class="glyphicon glyphicon glyphicon-plus-sign"></span>
                </button>
            </div>
        </div>
        <div id="actions-options"></div>

        <div id="select2-test">
            <input type="hidden" id="sel2-test" class="form-control"/>
            <script type="text/javascript" charset="utf-8">
                require(['jquery', 'select2'], function ($) {
                    /**
                     * params: {q:'', page:1, o:100}
                     * @param params
                     * @param url string
                     * @param callback function
                     **/
                    function search(params, url, callback) {
                        params.q = params.term || '*'; // '*' means default search
                        params.page = params.page || 1;
                        params.o = params.limit || 100;

                        params.searchedTerms = params.searchedTerms || {};
                        var termStatus = params.searchedTerms[params.term];
                        if (termStatus == undefined || (termStatus.loaded == 1 && termStatus.page < params.page)) { // if this is first load, or there are more pages and we're looking for next page
                            if (termStatus == undefined) {
                                params.searchedTerms[params.term] = {};
                            }
                            $.get(url, {page: params.page, q: params.q, o: params.o})
                                    .done(function (result) {
                                        if (result.hasOwnProperty('total_count')) {
                                            console.log(result['total_count']);
                                            var more = params.page * params.o < result['total_count'];
                                            params.searchedTerms[params.term].loaded = (more) ? 1 : 2; // 1 means more results to be fetched, 2 means all fetched
                                            params.searchedTerms[params.term].page = params.page; // 1 means more results to be fetched, 2 means all fetched
                                        }
                                        callback(result, params);
                                    })
                                    .fail(function (result) {
                                        callback(result, params);
                                    });
                        } else if (termStatus.loaded == 2 || (termStatus.page >= params.page)) {
                            callback('local', params); // find results from local storage
                        } else {
                            console.error("UNKNOWN search status.")
                        }
                    }

                    function searchLocal(term, values, page, limit) {
                        page = page || 1;
                        limit = limit || 100;
                        var counted = 0;
                        var offset = (page - 1) * limit; // offset from which to start fetching results
                        var max = offset + limit;
                        var regex;
                        if (term != '*') { // * is match all, don't try to search
                            regex = new RegExp(term, 'i');
                        }
                        var matches = $.grep(values, function (val) {
                            if (counted >= max) { // if already reached goal, don't add any more matches
                                return false;
                            }

                            var test;
                            if (regex) {
                                test = regex.test(val.text) || regex.test(val.sku); // if regex and it matches a term
                                if(test) {
//                                    console.log(term + ' matches ' + val.text);
                                    counted++; // up the counter
                                } else {
//                                    console.log(term + ' does not match ' + val.text);
                                }
                            } else {
                                counted++; // no regex, just return matching items by position
                                test = true;
                            }
                            return test && counted >= offset && counted < max;// if term is not for this page, skip it
                        });
                        return matches;
                    }

                    /**
                     * merge any number of arrays together
                     * @returns {Array}
                     */
                    function mergeResults() {
                        var result = [], bitSet = {}, arr, len;
                        var checker = arguments[arguments.length - 1]; // function to check if item is in set
                        if(!$.isFunction(checker)) {
                            throw "Last argument must be a function.";
                        }
                        for(var i = 0; i < (arguments.length - 1); i++){
                            arr = arguments[i];
                            if(!arr instanceof Array) {
                                continue;
                            }
                            len = arr.length;
                            while (len--) {
                                var itm = arr[len];
                                if (!checker(itm, bitSet)) {
                                    result.unshift(itm);
                                }
                            }
                        }
                        return result;
                    }

                    var url = '{{ APP.href('promo/conditions/products') }}';
                    var $sel2 = $('#sel2-test');
                    $sel2.select2({
                        placeholder: "Choose products",
                        multiple: true,
                        closeOnSelect: false,
                        dropdownCssClass: "bigdrop",
                        dropdownAutoWidth: true,
                        selectOnBlur: true,
                        formatSelection: function (item) {
                            return item.sku;
                        },
                        formatResult: function (item) {
                            var markup = '<div class="row-fluid" title="' + item.text + '">' +
                                    '<div class="span2">ID: <em>' + item.id + '</em></div>' +
                                    '<div class="span2">Name: ' + item.text.substr(0, 20);
                            if(item.text.length > 20) {
                                markup += '...';
                            }
                            markup += '</div>' +
                            '<div class="span2">SKU: <strong>' + item.sku + '</strong></div>' +
                            '</div>';

                            return markup;
                        },
                        query: function (options) {
                            var $el = $(options.element);
                            var values = $el.data('searches') || [];
                            var flags = $el.data('flags') || {};
                            var term = options.term || '*';
                            var page = options.page;console.log(page);
                            var data;
                            if (flags[term] != undefined && flags[term].loaded == 2) {
                                data = {results: searchLocal(term, values, page, 100), more: (flags[term].page > page)};
                                options.callback(data);
                            } else {
                                search({term: term, page: page, searchedTerms: flags}, url, function (result, params) {
                                    var more;
                                    if (result == 'local') {
                                        more = (params.searchedTerms[term].page > params.page) || (params.searchedTerms[term].loaded == 1);
                                        data = {results: searchLocal(params.term, values, params.page, params.o), more: more};
                                        options.callback(data);
                                    } else if(result.items !== undefined) {
                                        more = params.searchedTerms[term].loaded === 1;
                                        data = {results: result.items, more: more};
                                        flags[term] = params.searchedTerms[term];
                                        //todo merge values with results,
                                        values = mergeResults(values, data.results, function (item, bitSet) {
                                            var inSet = true;
                                            if(!bitSet[item.id]) {
                                                inSet = false;
                                                bitSet[item.id] = 1;
                                            }
                                            return inSet;
                                        });
                                        $el.data({searches: values, flags: flags});

                                        options.callback(data);
                                    }
                                })
                            }
                        }
                    })
                });
            </script>
        </div>
        <script type="text/javascript">
            require(['react', 'jsx!fcom.promo'], function (React, Promo) {
                $('.to-select2').select2({minimumResultsForSearch:15});
                var options = {
                    coupon_select_id: 'model-use_coupon',
                    condition_select_id: 'model-conditions_type',
                    coupon_container_id: 'coupon-options',
                    condition_container_id: 'conditions-options',
                    condition_add_id: 'condition_action_add',
                    conditions_serialized: 'conditions_serialized',
                    showCouponsUrl: "{{ APP.href('promo/coupons/view?id=') ~ m.id() }}", // "/admin/promo/coupons/view?id=1",
                    generateCouponsUrl: "{{ APP.href('promo/coupons/generate?id=') ~ m.id() }}", // "/admin/promo/coupons/generate?id=1",
                    importCouponsUrl: "{{ APP.href('promo/coupons/import?id=') ~ m.id() }}", // "/admin/promo/coupons/import?id=1",
                    valueUpc: '{{validator.fieldValue("uses_per_customer")}}',
                    valueUt: '{{validator.fieldValue("uses_total")}}',
                    singleCouponValue: '',
                    labelClass: '{{ labelClass }}',
                    debug: true,
                    base_url: "{{ APP.href('promo/') }}",
                    id_var: 'id',
                    entity_id: '{{ m.id() }}'
                };
                Promo.init(options);
            });
        </script>
    </div>
</fieldset>
