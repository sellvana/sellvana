{% set tabs = THIS.sortedTabs() %}
{% set formUrl = THIS.get('form_url') %}
{% set formId = THIS.get('form_id') %}
{% set curTab = THIS.get('cur_tab') %}
{% set validator = THIS.validator(formId, THIS.get('model')) %}

<script>


    require(["jquery", "underscore", "fcom.admin", "bootstrap", "jquery.validate"], function($, _) {

        $(function() {
            window.adminForm = FCom.Admin.form({
                form:     '{{ formId }}',
                tabs:     '.adm-tabs-sidebar li',
                panes:    '.adm-tabs-content',
                url_get:  '{{ formUrl }}',
                url_post: '{{ formUrl }}'
            });
            var mainForm = '{{ formId }}';

            $('#' + mainForm).on('keypress', 'input', function (e) {
                var charCode = e.charCode || e.keyCode || e.which;
                if (charCode == 13) {
                    //enter will submit instead call first input type submit
                    if ($(e.target).parents('div.f-grid-wrapper').length == 0) {
                        $("#{{ formId }}").submit();
                    }
                    //prevent enter to submit form to avoid filter issue
                    return false;
                }
            });

            $.validator.addMethod('passwordSecurity', validatePasswordSecurity, 'Password must be at least 7 characters in length and must include at least one letter, one capital letter, one number, and one special character.');
            function validatePasswordSecurity (value, element, param) {
                var regex = /(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[~!@#$%^&*()_+=}{><;:\]\[?]).{7,}/;
                if (value.length > 0 && !regex.test(value)) {
                    return false;
                }
                return true;
            }
            $.fn.strengthLevelPassword = function () {
                var html = '<div class="progress" style="margin-bottom: 0; margin-top: 5px">' +
                        '<div id="progress-bar-password" class="progress-bar bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div></div>';
                $(this).parent().append(html);
                $(this).keyup(function () {
                    var regex = /(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[~!@#$%^&*()_+=}{><;:\]\[?]).{7,}/;
                    if (regex.test($(this).val())) {
                        $('#progress-bar-password').css('width', '70%');
                        if ($(this).val().length > 12) {
                            $('#progress-bar-password').css('width', '70%');
                        }
                        $('#progress-bar-password').parent().removeClass('progress-warning');
                    } else {

                        if ($(this).val().length > 7) {

                        } else if ($(this).val().length == 0) {
                            $('#progress-bar-password').css('width', '0%');
                        } else {
                            $('#progress-bar-password').css('width', '30%');
                        }
                        $('#progress-bar-password').parent().addClass('progress-warning');
                    }
                })
            }
            $('.has-progress-bar').strengthLevelPassword();
            $('#' + mainForm).validate({
                ignore: [],//for invisible elements
                invalidHandler: function(event, validator) {
                    var info = {};
                    console.log(validator.invalid);
                    for(key in validator.invalid) {
                        var element = jQuery('input[name="'+key+'"], textarea[name="'+key+'"], select[name="'+key+'"]');
                        if (element.length>0) {
                            var tab = element.parents('div.js-main-form-tab:first');
                            var key = '#'+tab.attr('id');
                            if (typeof(info[key]) === 'undefined')
                                info[key] = 1;
                            else
                                info[key]++;
                        }
                    }

                    $('ul#tabs').find('li a').each(function(index) {
                        var val = info[$(this).attr('href')];
                        if (typeof(val) !== 'undefined')
                         {
//                            if ($(this).find('span.badge').length === 0) {
//                                $(this).append('<span class="badge badge-important"></span>');
//                            }
//                            $(this).find('span.badge').html(val>0 ? val : '');
                            if ($(this).find('i.error').length === 0) {
                                $(this).append('<i class="icon-warning-sign error"></i>');
                            }
                        } else {
                            $(this).find('i.error').remove();
//                            $(this).find('span.badge').remove();
                        }
                    });
                    for(key in info) {
                        $('a[href="'+key+'"]').trigger('click');
                        break;
                    }

                }
            });
            $('#' + mainForm).find('input, textarea, select').on('change', function () {
                $('ul#tabs').find('li.active').each(function () {
                    if ($(this).children('a').find('i.icon-pencil').length === 0) {
                        if ($(this).children('a').children('i.error').length !== 0) {
                            $('<i class="icon-pencil"></i>').insertBefore($(this).children('a').children('i.error'));
                        } else {
                            $(this).children('a').append('<i class="icon-pencil"></i>');
                        }
                    }
                })
            })

            FCom.Admin.Tabs('.f-admin-main', {
                url_get: "{{ formUrl }}",
                cur_tab: "{{ curTab }}",
                tab_load_callback: function(i) {
                    adminForm.createSwitchButton();
                    adminForm.wysiwygInit();
                }
            });

            //init
            adminForm.createSwitchButton();
            adminForm.wysiwygInit();
        });
    });
</script>

<form id="{{ formId }}" class="form form-horizontal validate-form" action="{{ formUrl }}" method="post">
    <div class="page-header f-page-header-has-btns">
      <h1 class="f-page-title">
          <i class="icon-table"></i>
          {{ THIS.get('title') }}
      </h1>
      <div class="btn-group">
          {{ THIS.get('actions') | join(' ') | raw }}
      </div>
        {% if THIS.get('otherInfo') %}
            <div style="clear: both;">{{ THIS.get('otherInfo') }}</div>
        {% endif %}
    </div>

    {{ THIS.view('core/messages') | raw }}

    <div class="row f-admin-main f-admin-sidebar-view">
      <div class="tabbable tabs-left">
        <ul class="nav nav-tabs nav-stacked f-admin-nav-sidebar" id="tabs">
            {% if THIS.get('sidebar_img') %}
                <li><img src="{{ THIS.get('sidebar_img') | raw }}" width="98" height="98" /></li>
            {%  endif %}
            {% for k, tab in tabs %}
                {% if tab.disabled is empty %}
                    <li>
                        <a class="js-form-tab-toggle" href="#tab-{{ k }}" data-toggle="tab">
                            <span class="icon"></span>
                            {{ tab.label }}
                        </a>
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
        <div class="tab-content">
            {% for k, tab in tabs %}
                <div class="tab-pane js-main-form-tab" id="tab-{{ k }}" {% if not tab.async %} data-loaded="true" {% endif %}>
                    {% if not tab.async %}
                        {{ THIS.view(tab.view).set('validator', validator) | raw }}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
      </div>
    </div>
</form>

<div id="fcom_append_form">
</div>
