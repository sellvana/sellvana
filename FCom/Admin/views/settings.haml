- $formUrl = BApp::href('settings');

:css
    /*ul.nav li.dropdown:hover > ul.dropdown-menu {
        display: block;    
    }*/

:javascript
    $(function() {
        function onSortableStop(event, ui) {
            var type = ui.item[0].nodeName.toLowerCase()=='li' ? 'tabs' : 'sections';
            console.log(ui.item[0].id);
            var handle = ui.item;
            if (type=='tabs') handle = handle.children('h3');
            handle.triggerHandler('focusout');

            return; //TODO: figure out whether to personalize settings items order

            var url = '#{BApp::href('my_account/personalize')}';

            switch (type) {
            case 'tabs':
                var items = [];
                ui.item.parent().children().each(function(idx, el) {
                    items.push(el.id.replace(/^settings-tab-/, ''));
                });
                //$.post(url, {'do':'settings.'+type+'.order', items:items});
                break;

            case 'sections':
                var items = [];
                break;
            }
        }

        window.adminForm = FCom.Admin.form({
            form:     '#settings-form',
            tabs:     '.adm-tabs-sidebar li',
            panes:    '.adm-tabs-content',
            url_get:  '#{$formUrl}',
            url_post: '#{$formUrl}'
            //on_tab_load: initTabs
        });
        $('#settings-form').validate();
        //initTabs.apply($('#settings-form'));
        //$('.adm-tabs-sidebar > ul').sortable({axis: 'y', stop: onSortableStop, distance:5});

        var options = {
            url_get: "#{$formUrl}"
        }
        $('.js-settings-tab-toggle').click(function(ev) {
            ev.preventDefault();
            var paneSel = ev.target.href.replace(/^[^#]*/, ''), pane = $(paneSel), tabId = paneSel.replace(/^#tab-/,'');
            if (!pane.data('loaded')) {
                var url_get = options.url_get+(options.url_get.match(/\?/) ? '&' : '?');
                $.getJSON(url_get+'tabs='+tabId, function(data, status, req) {
                    _.each(data.tabs, function(tabHtml, i) { 
                        $('#tab-'+i).html(tabHtml).data('loaded', true)
                            .find('.collapse').collapse();
                    });
                });
            }
            $('#current_tab').val(ev.target.id.replace(/^tab-/, ''));
            $(this).tab('show');
            console.log(this);
        })
        $('[href="#tab-#{$this->cur_tab}"]').tab('show');
        FCom.Admin.initCodeEditors() 
    });

%form#settings-form(action="#{$formUrl}" method="post")
    %input#current_tab(type="hidden" name="current_tab" value="FCom_Admin")

    %header.adm-page-title
        %span.title = $this->_('Settings')
        .btns-set
            %button.st1.sz2.btn(type="submit" onclick="return adminForm.saveAll(this)")
                %span = $this->_('Save All')

    - echo $this->messagesHtml()

    %section.adm-content-box
        %ul.nav.nav-tabs
            - foreach ($this->tab_groups as $gk => $group)
                %li.dropdown
                    %a.dropdown-toggle(href="#" data-toggle="dropdown") = $group['label']
                    %ul.dropdown-menu(a="a" #{!empty($group['open']) ? '' : 'hidden'})
                        - foreach ($group['tabs'] as $k => $tab)
                            - if (empty($tab['disabled']))
                                %li(id="settings-tab-#{$k}")
                                    %a.js-settings-tab-toggle(href="#tab-#{$k}")
                                        %span.icon
                                        = $tab['label']
        .tab-content
            - foreach ($this->tabs as $k=>$tab)
                .tab-pane(id="tab-#{$k}" #{empty($tab['async']) ? 'data-loaded="true"' : ''})
                    - if (empty($tab['async']))
                        - echo $this->view($tab['view'])
