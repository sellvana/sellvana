{% set m = THIS.get('model') %}
{% set resizeUrl = APP.instance('FCom_Core_Main').resizeUrl() %}
<div class="form-group">
    <div class="col-md-2 control-label">{{ "ID: %s"|_(m.id()) }}</div>
</div>
<div class="form-group">
    <label class="col-md-2 control-label" for="main-node_name">{{ 'Label'|_ }}</label>
    <div class="col-md-5">
        <input class="form-control required" id="main-node_name" type="text" name="model[node_name]" value="{{ m.get('node_name') }}" />
    </div>
</div>
<div class="form-group">
    <label class="col-md-2 control-label" for="main-url_key">{{ 'Url Key'|_ }}</label>
    <div class="col-md-5">
        <input class="form-control required" id="main-url_key" type="text" name="model[url_key]" value="{{ m.get('url_key') }}" />
    </div>
</div>

<div class="form-group">
    <label class="col-md-2 control-label" for="model-is-top-menu">{{ 'Display In Navigation'|_ }}</label>
    <div class="col-md-5">
        <input type="hidden" name="model[is_top_menu]" value="0" />
        <input id="model-is-top-menu" class="switch-cbx" name="model[is_top_menu]" {% if m.get('is_top_menu') == 1 %}checked="checked"{% endif %} value='1' type='checkbox' />
    </div>
</div>
<div class="form-group">
    <label class="col-md-2 control-label" for="model-is_enabled">{{ 'Enable'|_ }}</label>
    <div class="col-md-5">
        <input type="hidden" name="model[is_enabled]" value="0" />
        <input id="model-is_enabled" class="switch-cbx" name="model[is_enabled]" {% if m.get('is_enabled') == 1 %}checked="checked"{% endif %} value='1' type='checkbox' />
    </div>
</div>

<div class='form-group'>
    <label class="col-md-2 control-label" for="model-image">{{ 'Image'|_ }}</label>
    <div class='col-md-10'  id='cat-image-fileupload'>
        <div class='box-content' id="content-image">
            <div class='row fileupload-buttonbar' id="btn-select-img">
                <div class='col-sm-12'>
                    <span class='btn btn-primary fileinput-button' id='btn_add_image'>
                        <i class='icon-plus icon-white'></i>
                        <span>{{ 'Add Image...'|_ }}</span>     
                        <input id="model-image-url" type="hidden" name="model[image_url]" />
                    </span>
                </div>
                <div class='col-sm-5 fileupload-progress fade'>
                    <div aria-valuemax='100' aria-valuemin='0' class='progress progress-success progress-striped active' 
                    role='progressbar'>
                        <div class='bar' style='width:0%;'></div>
                    </div>
                    <div class='progress-extended'> </div>
                </div>
            </div>
            <div class='fileupload-loading'></div>
            <br>
            <div id="current-image">
                {% if m.get('image_url') %}
                    <img src={{ resizeUrl }}?s=150x150&f={{ m.get('image_url') }} />
                {% endif %}
            </div>
            <table class='table table-striped' role='presentation' id="table-image">
                <tbody class='files' data-target='#modal-gallery' data-toggle='modal-gallery'></tbody>
            </table>
        </div>
        
    </div>
</div>


<div class="form-group">
    <label class="col-md-2 control-label" for="model-description">{{ 'Internal Notes'|_ }}</label>
    <div class="col-md-10">
        <textarea id="model-description" class="form-control" rows="5" name="model[description]">{{ m.get('description') }}</textarea>
    </div>
</div>

<div class="form-group">
    <label class="col-md-2 control-label" for="main-page_title">{{ 'Page Title'|_ }}</label>
    <div class="col-md-5">
        <input class="form-control" id="main-page_title" type="text" name="model[page_title]" value="{{ m.get('page_title') }}" />
    </div>
</div>
<div class="form-group">
    <label class="col-md-2 control-label" for="main-meta_title">{{ 'Meta Title'|_ }}</label>
    <div class="col-md-5">
        <input class="form-control" id="main-page_title" type="text" name="model[page_title]" value="{{ m.get('page_title') }}" />
    </div>
</div>
<div class="form-group">
    <label class="col-md-2 control-label" for="model-meta_description">{{ 'Meta Description'|_ }}</label>
    <div class="col-md-10">
        <textarea id="model-meta_description" class="form-control" rows="5" name="model[meta_description]">
            {{ m.get('meta_description') }}
        </textarea>
    </div>
</div>
<div class="form-group">
    <label class="col-md-2 control-label" for="model-meta_keywords">{{ 'Meta Keywords'|_ }}</label>
    <div class="col-md-10">
        <textarea id="model-meta_keywords" class="form-control" rows="5" name="model[meta_keywords]">{{ m.get('meta_keywords') }}
        </textarea>
    </div>
</div>

<script>    
require(['jquery'], function($) {
    $('#btn_add_image').click(function() {
        $('#cat-image-grid-modal').modal();
    }); 
});
</script>

{% set mediaLibImageConfig = APP.instance('FCom_Admin_Controller_MediaLibrary').gridConfig({'id': 'category_images', 'folder': 'media/category/images'}) %}

<script>
    var mediaGrid;
    require(['jquery','underscore','backbone'], function($, _) {
            
        /*
        *MediaGrid registery function
        */
        window.category_images_register = function(grid) {
            mediaGrid = grid;
            grid.getGridSkeleton().Views.RowView.prototype._selectRow = function(ev) {            
                var selectedRows = grid.getSelectedRows();

                var checked = $(ev.target).is(':checked');
                $('.select-row').prop('checked', false);
                $(ev.target).prop('checked', checked);

                this.model.set('selected', checked);            
                selectedRows.reset();
                console.log(selectedRows.length);
                if (checked) {            
                    selectedRows.add(this.model);
                    $('.cat-image-modal-add').removeClass('disabled');
                } else {            
            
                    $('.cat-image-modal-add').addClass('disabled');
                }
                console.log(selectedRows.length);
                ev.stopPropagation();
                ev.preventDefault();

                return;
            }

            grid.build();                

            $('.cat-image-modal-add').click(function() {
                var row = mediaGrid.getSelectedRows().at(0);            
                var path = row.get("folder") + row.get("subfolder") + "/" + row.get("file_name");
                var imageTag = '<img src="{{ resizeUrl }}?s=150x150&cache=0&f='+ path +'" />';
                $('#model-image-url').val(path);
                $('#current-image').html(imageTag); 
                mediaGrid.getGridView().clearSelectedRows();
                $('.cat-image-modal-close').trigger('click');
            });        
        }    
    });

    require(['tmpl', 'load-image', 'canvas-to-blob', 'iframe-transport', 'jquery.fileupload','jquery.fileupload-fp','jquery.fileupload-ui'], function() {
        $('#prod-image-fileupload').fileupload({
            url: '{{ APP.href("media/grid/upload?folder=media/category/images") | raw}}',
            multiple:true,
            acceptFileTypes:  /(\.|\/)(jpe?g|tiff|gif|png|bmp)$/i
        })
        .bind('fileuploadalways', function(e, data) {
            if(data.result.id) {
                mediaGrid.getRows().add(data.result);

                $('td.name span').each(function(i) {
                    if($(this).html() === data.result.file_name)
                    $(this).parents('tr:first').remove();
                });                
            }
        });
    });

</script>

{{ THIS.view('core/backbonegrid').set('grid', prodImagesConfig) | raw }}

<a role="button" href="#cat-image-grid-modal" data-toggle="modal" style='display:none;' id='btn_cat_image_modal'>{{ "Add"|_ }}</a>
<div class='modal fade' id='cat-image-grid-modal' tabindex='-1'>
    <div class='modal-dialog' style='width:1050px;'>
        <div class='modal-content'>
            <div class='modal-body'>
                <div class='row'>
                    <div class='col-sm-12'>
                    <div class='tabbable'>
                        <ul class='nav nav-tabs prod-type'>
                            <li class='active'>
                                <a data-toggle='tab' href='#images_library'>
                                    {{ 'Library'|_ }}
                                </a>
                            </li>
                            <li>
                                <a data-toggle='tab' href='#prod-image-fileupload'>
                                    {{ 'Upload'|_ }}
                                </a>
                            </li>
                        </ul>
                        <div class='tab-content'>
                            <div class='tab-pane active' id='images_library'>
                                {{ THIS.view('core/backbonegrid').set('grid', mediaLibImageConfig) | raw }}
                            </div>
                            <div class='tab-pane'  id='prod-image-fileupload'>
                                <div class='box-content'>
                                    <div class='row fileupload-buttonbar'>
                                        <div class='col-sm-12'>
                                            <span class='btn btn-success fileinput-button'>
                                                <i class='icon-plus icon-white'></i>
                                                <span>{{ 'Add files...'|_ }}</span>
                                                <input data-bfi-disabled='' multiple='' name='upload[]' type='file' >
                                            </span>
                                            <button class='btn btn-primary start' type='submit'>
                                                <i class='icon-upload icon-white'></i>
                                                <span>{{ 'Start upload'|_ }}</span>
                                            </button>
                                            <button class='btn btn-warning cancel' type='reset'>
                                                <i class='icon-ban-circle icon-white'></i>
                                                <span>{{ 'Cancel upload'|_ }}</span>
                                            </button>                                                            
                                        </div>
                                        <div class='col-sm-5 fileupload-progress fade'>
                                            <div aria-valuemax='100' aria-valuemin='0' class='progress progress-success progress-striped active' role='progressbar'>
                                                <div class='bar' style='width:0%;'></div>
                                            </div>
                                                <div class='progress-extended'></div>
                                        </div>
                                    </div>
                                        <div class='fileupload-loading'></div>
                                        <br>
                                        <table class='table table-striped' role='presentation'>
                                            <tbody class='files' data-target='#modal-gallery' data-toggle='modal-gallery'></tbody>
                                        </table>
                                </div>
                                <script>
                                    var uploadTr = '{{ 'Upload'|_ }}';
                                    var errorTr = '{{ 'Error'|_ }}';
                                    var cancelTr = '{{ 'Cancel'|_ }}';
                                </script>
                                {% verbatim %}
                                <script id="template-upload" type="text/x-tmpl">
                                    {% for (var i=0, file; file=o.files[i]; i++) { %}
                                        <tr class="template-upload fade">
                                            <td class="preview"><span class="fade"></span></td>
                                            <td class="name"><span>{%=file.name%}</span></td>
                                            <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
                                            {% if (file.error) { %}
                                                <td class="error" colspan="2"><span class="label label-important">{%=errorTr%}</span> {%=file.error%}</td>
                                            {% } else if (o.files.valid && !i) { %}
                                            <td>
                                                <div class="progress progress-success progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                                    <div class="bar" style="width:0%;"></div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if (!o.options.autoUpload) { %}
                                                    <button class="btn btn-primary start">
                                                        <i class="icon-upload icon-white"></i>
                                                        <span>{%=uploadTr%}</span>
                                                    </button>
                                                {% } %}
                                            </td>
                                            {% } else { %}
                                                <td colspan="2"></td>
                                            {% } %}
                                            <td>
                                               {% if (!i) { %}
                                                <button class="btn btn-warning cancel">
                                                    <i class="icon-ban-circle icon-white"></i>
                                                    <span>{%=cancelTr%}</span>
                                                </button>
                                                {% } %}
                                            </td>
                                        </tr>
                                    {% } %}
                                </script>
                                <!-- The template to display files available for download -->

                                <script id="template-download" type="text/x-tmpl">
                                    {% for (var i=0, file; file=o.files[i]; i++) { %}
                                        <tr class="template-download fade">
                                           {% if (file.error) { %}
                                                <td></td>
                                                <td class="name"><span>{%=file.name%}</span></td>
                                                <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
                                                <td class="error" colspan="2"><span class="label label-important">{%=errorTr%}</span> {%=file.error%}</td>
                                            {% } else { %}
                                                <td class="preview">
                                                {% if (file.thumbnail_url) { %}
                                                    <a href="{%=file.url%}" title="{%=file.name%}" data-gallery="gallery" download="{%=file.name%}">
                                                        <img src="{%=file.thumbnail_url%}">
                                                    </a>
                                                {% } %}
                                                </td>
                                                <td class="name">
                                                    <a href="{%=file.url%}" title="{%=file.name%}" data-gallery="{%=file.thumbnail_url&&'gallery'%}" download="{%=file.name%}">
                                                        {%=file.name%}
                                                    </a>
                                                </td>
                                                <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
                                                <td colspan="2"></td>
                                            {% } %}
                                            <td>
                                                <input type="checkbox" name="delete" value="1" class="toggle">
                                            </td>
                                        </tr>
                                    {% } %}
                                </script>
                                {% endverbatim %}
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-primary btn-add cat-image-modal-add disabled' data-dismiss='modal' type='button'>{{ "Add"|_ }}</button>
                <button class='btn btn-default btn-close cat-image-modal-close' data-dismiss='modal' type='button'>{{ "Close"|_ }}</button>
            </div>
        </div>
    </div>
</div>

