- $formUrl = BApp::href('catalog/categories/tree_form/')
%header.fcom-admin-main-title
    %span.title = $this->_('Categories')
    .btn-group

.fcom-admin-main-container.fcom-admin-sidebar-view#categories-layout

    %form.fcom-admin-main-content#categories-tree-form(action="#{$formUrl}" method="post")
        #categories-form-container
    %aside.fcom-admin-nav-sidebar
        .ui-widget-header
            = $this->_('Categories')
            %input#categories-tree-lock(type="checkbox")
            %input#categories-expand-collapse(type="checkbox")
        #categories

:javascript
    require(['jquery', 'fcom.admin', 'jstree', 'fcom.admin'], function($) {
        $(function() {
            $('.fcom-admin-nav-sidebar').resizable({
                handles: 'e',
                resize: function(ev, ui) { 
                    $('#categories-layout').css('padding-left', ui.size.width+'px');
                }
            });
            FCom.Admin.checkboxButton('#categories-tree-lock', {def:true, on:{icon:'unlocked', label:'Unlocked'}, off:{icon:'locked', label:'Locked'}});
            FCom.Admin.checkboxButton('#categories-expand-collapse', {
                off:{icon:'triangle-1-e', label:'Expand All'}, on:{icon:'triangle-1-s', label:'Collapse All'},
                click:function(ev) { $('#categories').jstree(this.checked?'open_all':'close_all', $('#1>ul>li')); }
                //TODO: fetch ancestors only for root node
            });

            FCom.Admin.tree('#categories', {
                url:'#{BApp::href('catalog/categories/tree_data')}'
                , on_dblclick: function (n) { loadForm(n.attr('id')); }
                , on_select: function (n) { loadForm(n.attr('id')); }
                , lock_flag: '#categories-tree-lock'
            });
            /*
            var cmsNavLayout = $('#categories-layout').height($('.adm-wrapper').height()).layout({
                useStateCookie: true,
                west__minWidth:400,
                west__spacing_open:1,
                west__closable:false,
                triggerEventsOnLoad: true,
                onresize:function(pane, $Pane, paneState) {
                    $('.ui-jqgrid-btable:visible', $Pane).each(function(index) {
                        if (!this.id.match(/_t$/)) {
                            $(this).setGridWidth(paneState.innerWidth - 20);
                        }
                    });
                }
            });
            */
            function loadForm(id) {
                var url = '#{$formUrl}?id='+id;
                $('#categories-form-container').load(url, function() {
                    $('#categories-tree-form').attr('action', url);
                    window.adminForm = FCom.Admin.form({
                        tabs:     '.adm-tabs li',
                        panes:    '.adm-tabs-content',
                        url_get:  url,
                        url_post: url
                    });
                });
            }

        })
    })
