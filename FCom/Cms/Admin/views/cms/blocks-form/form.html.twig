<!--{ label: Form Fields }-->
<!--{ pos: 30 }-->

{% set blockCtrl = APP.instance('FCom_Cms_Admin_Controller_Blocks') %}

<script type="text/javascript">
    require(['backbone', 'underscore', 'jquery'], function (Backbone, _, $) {
        var mainGrid;
        var inputName = 'input[data-col="name"]';
        var inputOption = 'input[data-col="options"]';
        var selectFieldType = 'select[data-col="input_type"]';
        window.formFieldGridRegister = function (grid) {
            mainGrid = grid;
//            mainGrid.getGridSkeleton().Views.RowView.prototype.afterRender = function () {
//                var self = this;
//                this.$el.find(inputName).addClass('unique');
//                this.$el.find(inputOption).addClass('requiredOptions');
//                if (this.model.get('input_type') != 'select') {
//                    this.$el.find(inputOption).prop('disabled', true);
//                }
//                this.$el.find(selectFieldType).change(function () {
//                    if ($(this).val() == 'select') {
//                        self.$el.find(inputOption).prop('disabled', false);
//                    } else {
//                        self.$el.find(inputOption).prop('disabled', true);
//                    }
//                })
//            };
            mainGrid.build();
            var $modal = $('#frontend-field-grid-modal');
            var mainFields = {
                name: 1,
                label: 1,
                input_type: 1,
                required: 1,
                position: 1
            };

            if ($modal[0]) {
                var $fields = $modal.find('select,input,textarea');
                var $addBtn = $modal.find('button.save');
                var rowTpl = mainGrid.getGridSkeleton().Models.Row;
                $addBtn.click(function (e) {
                    var temp = new rowTpl;
                    var options = {};
                    $fields.each(function(i, o){
                        var $el = $(o);
                        var disabled = $el.prop('disabled');
                        if (!disabled) {
                            var fieldName = $el.prop('name');
                            var fieldType = $el.prop('type');
                            var fieldValue = $el.val();
                            if ((fieldType == 'checkbox' || fieldType == 'radio') && !$el.prop('checked')) {
                                return;
                            }
                            if (mainFields[fieldName]) {
                                temp.set(fieldName, fieldValue);
                            } else {
                                options[fieldName] = fieldValue;
                            }
                            console.log(temp);
                        }
                    });
                    if ($.isEmptyObject(options) == false) {
                        temp.set('options', JSON.stringify(options));
                    }
                    var rows = mainGrid.getRows();
                    temp.set('_new', true);
                    temp.set('id', rows.size() +1);
                    rows.add(temp);
                    $modal.modal('hide');
                    e.preventDefault();
                });
                $(mainGrid.getGridSkeleton().AddButton).click(function () {
                    $modal.modal('show');
                });
            }
        };
        $('#cms-blocks-form').submit(function (ev) {
            var rows = mainGrid.getRows().toJSON();

            var res = [];
            for (var i in rows) {
                if (rows[i].position.length == 0) {
                    rows[i].position = 0;
                }
                res.push(_.pick(rows[i], 'id', 'name', 'label', 'input_type', 'required', 'options', 'position'));
            }

            $("#block_form_fields_data").val(JSON.stringify(res));
        });
        function checkUnique(value, elem, params) {
            var error = true;
            if (typeof (elem) !== 'undefined') {
                var parent = $(elem).parents('tr');
                var val = parent.find(inputName).val();
                mainGrid.getRows().each(function (data) {
                    if (parent.attr('id') != data.get('id') && val == data.get('name')) {
                        error = false;
                    }
                });
            }

            return error;
        }

        $.validator.addMethod('checkUnique', checkUnique, '{{ "Field Name are already taken place."|_ }}');

        $.validator.addClassRules("requiredOptions", {
            required: function (value, elem, params) {
                var error = true;
                if (typeof (elem) !== 'undefined') {
                    var parent = $(elem).parents('tr');
                    if (parent.find(selectFieldType).val() == 'select' && value.trim().length == 0) {
                        error = false;
                    }
                }
                return error;
            }
        });

        $.validator.addClassRules("unique", {
            required: true,
            checkUnique: true
        });

    });
</script>

{{ forms.boolean(fieldData, {field:'form_enabled', label:'Form Enabled'|_}) }}

<input type='hidden' id='block_form_fields_data' name='model[form_fields]'/>
<div class="row">
    <div class="col-sm-10">
        {{ THIS.view('core/backbonegrid').set('grid', blockCtrl.formFieldGrid(model))| raw }}
    </div>
</div>



{#<div class='' id='frontend-field-grid-modal' tabindex='-1'>#}
<div class='modal fade' id='frontend-field-grid-modal' tabindex='-1'>
    <div class='modal-dialog'>
        <div class='modal-content'>
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">{{ "Add field"|_ }}</h4>
            </div>
            <div class='modal-body'>
                <div class=" field-element-wrapper">
                    <div class="form-group">
                        <label for="input_type" class="col-sm-3 control-label required">{{ "Field Type"|_ }}</label>
                        <div class="controls col-sm-5">
                            <select name="input_type" class="form-control required" id="input_type">
                                <option value="-" selected>{{ "-- Select field type --"|_ }}</option>
                                <option value="text">{{ "Single Line Text"|_ }}</option>
                                <option value="textarea">{{ "Paragraph Text" }}</option>
                                <option value="rte">{{ "Rich Text"|_ }}</option>
                                <option value="number">{{ "Number"|_ }}</option>
                                <option value="email">{{ "Email Address"|_ }}</option>
                                <option value="url">{{ "Website/URL"|_ }}</option>
                                <option value="image">{{ "Image URL"|_ }}</option>
                                <option value="file">{{ "File Upload"|_ }}</option>
                                <option value="date">{{ "Date"|_ }}</option>
                                <option value="tel">{{ "Phone Number"|_ }}</option>
                                <option value="hidden">{{ "Hidden Field"|_ }}</option>
                                <option value="time">{{ "Time"|_ }}</option>
                                <option value="password">{{ "Password"|_ }}</option>
                                <option value="checkbox">{{ "Checkbox"|_ }}</option>
                                <option value="radio">{{ "Radio"|_ }}</option>
                                <option value="select">{{ "Dropdown"|_ }}</option>
                                <option value="select-multi">{{ "Multi select"|_ }}</option>
                            </select>
                        </div>
                        <div class="-hidden-field">
                            <label class="control-label col-sm-2" for="position">{{ "Position"|_ }}</label>
                            <div class="col-sm-2"><input type="number" name="position" id="position"
                                                         class="form-control"/></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="field_id" class="control-label required col-sm-3">{{ "Field Id" }}</label>
                        <div class=" col-sm-5">
                            <input type="text" id="field_id" name="field_id" class="form-control required">
                        </div>
                        <div class=" -hidden-field -select-field -select-multi-field -password-field ">
                            <label class="control-label col-sm-2" for="readonly">{{ "Read Only"|_ }}</label>
                            <div class="col-sm-2">
                                <select id="readonly" name="readonly" class="form-control valid">
                                    <option value="0">{{ "no"|_ }}</option>
                                    <option value="1">{{ "YES"|_ }}</option>
                                </select>
                            </div>
                        </div>

                    </div>
                    <div class="form-group">
                        <label for="name" class="control-label col-sm-3 required">{{ "Field name"|_ }}</label>
                        <div class="col-sm-5"><input type="text" name="name" id="name" class="form-control required" value=""/></div>
                        <div class=" -hidden-field">
                            <label class="control-label col-sm-2" for="required">{{ "Required"|_ }}</label>
                            <div class="col-sm-2">
                                <select id="required" name="required" class="form-control valid">
                                    <option value="0">{{ "no"|_ }}</option>
                                    <option value="1">{{ "YES"|_ }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group -hidden-field">
                        <label class="control-label col-sm-3 required" for="label">{{ "Field Label"|_ }}</label>
                        <div class="col-sm-9"><input type="text" name="label" id="label" class="form-control required" value=""/></div>
                    </div>

                    <div class="form-group -hidden-field">

                                <label class="control-label col-sm-3" for="css_class">{{ "CSS classes"|_ }}</label>
                            <div class="col-sm-9"><input type="text" name="css_class"
                                                         id="css_class" class="form-control" value=""></div>
                    </div>

                    <div class="form-group -select-multi-field -image-field -file-field">
                        <label class="control-label col-sm-3"
                                    for="field_default_value">{{ "Default Value"|_ }}</label>
                        <div class="col-sm-9"><textarea name="field_default_value"
                                                     id="field_default_value" class="form-control text" ></textarea></div>
                    </div>
                    <div class="form-group managed textarea-field text-field url-field tel-field email-field password-field">
                        <label class="control-label col-sm-3"
                                    for="field_placeholder">{{ "Placeholder"|_ }}</label>
                        <div class="col-sm-9"><input type="text" name="field_placeholder"
                                                     id="field_placeholder" class="form-control" value=""/></div>
                    </div>
                    <div class="form-group managed number-field date-field time-field text-field url-field
                                                tel-field email-field password-field textarea-field select-field select-multi-field">
                        <div class="managed textarea-field">
                            <label class="control-label col-sm-3" for="maxlength">{{ "Max length"|_ }}</label>
                            <div class="col-sm-3">
                                <input type="text" name="maxlength" value="" class="form-control" id="maxlength">
                            </div>
                        </div>
                        <div class="managed number-field date-field time-field text-field url-field
                                                    tel-field email-field password-field select-field select-multi-field">
                            <label class="control-label col-sm-3" for="size">{{ "Size"|_ }}</label>
                            <div class="col-sm-3">
                                <input type="text" name="size" id="size" value="" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="form-group managed textarea-field">
                        <label class="control-label col-sm-3" for="rows">{{ "Rows"|_ }}</label>
                        <div class="col-sm-3">
                            <input type="text" name="rows" value="" class="form-control" id="cols">
                        </div>
                        <label class="control-label col-sm-3" for="cols">{{ "Cols"|_ }}</label>
                        <div class="col-sm-3">
                            <input type="text" name="cols" id="cols" value="" class="form-control">
                        </div>
                    </div>

                    <div class="form-group managed select-field select-multi-field radio-field checkbox-field" id="options-group">
                        <label class="control-label col-sm-3" for="options">{{ "Add/Remove options"|_ }}</label>
                        <div class="col-sm-9"><input type="text" name="options" id="options" class="form-control"/>
                        <p class="help-block">{{ "Comma separated list of values"|_ }}</p>
                        </div>
                    </div>

                    <div class="form-group managed checkbox-field radio-field">
                        <label class="control-label col-sm-3" for="checked">{{ "Default checked"|_ }}</label>
                        <div class="col-sm-2 checkbox">
                            <select id="checked" name="checked" class="form-control valid">
                                <option value="0">{{ "no"|_ }}</option>
                                <option value="1">{{ "YES"|_ }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group managed image-field submit-field">
                        <label class="control-label col-sm-3" for="formaction">{{ "Form action"|_ }}</label>
                        <div class="col-sm-9"><input type="text" name="formaction" id="formaction" class="form-control" value=""/></div>
                    </div>

                    <div class="form-group managed submit-field">
                        <label class="control-label col-sm-3" for="formnovalidate">{{ "No form validate"|_ }}</label>
                        <div class="col-sm-2">
                            <select id="formnovalidate" name="formnovalidate" class="form-control valid">
                                <option value="0">{{ "no"|_ }}</option>
                                <option value="1">{{ "YES"|_ }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group managed image-field">
                        <label class="control-label col-sm-3" for="src">{{ "Src"|_ }}</label>
                        <div class="col-sm-9"><input type="text" name="src" id="src" class="form-control" value=""/></div>
                    </div>

                    <div class="form-group managed image-field">
                        <label class="control-label col-sm-3" for="height">{{ "Height"|_ }}</label>
                        <div class="col-sm-3"><input type="text" name="height" id="height" class="form-control" value=""/></div>
                        <label class="control-label col-sm-3" for="width">{{ "Width"|_ }}</label>
                        <div class="col-sm-3"><input type="text" name="width" id="width" class="form-control" value=""/></div>
                    </div>

                    <div class="form-group managed number-field date-field time-field">
                        <label class="control-label col-sm-3" for="min">{{ "Min value"|_ }}</label>
                        <div class="col-sm-2"><input type="text" name="min" id="min" class="form-control" value=""/></div>
                        <label class="control-label col-sm-2" for="max">{{ "Max value"|_ }}</label>
                        <div class="col-sm-2"><input type="text" name="max" id="max" class="form-control" value=""/></div>
                        <label class="control-label col-sm-1" for="step">{{ "Step"|_ }}</label>
                        <div class="col-sm-2"><input type="text" name="step" id="step" class="form-control" value=""/></div>
                    </div>

                    <div class="form-group managed email-field file-field">
                        <label class="control-label col-sm-3" for="multiple">{{ "Multiple"|_ }}</label>
                        <div class="col-sm-2">
                            <select id="multiple" name="multiple" class="form-control valid">
                                <option value="0">{{ "no"|_ }}</option>
                                <option value="1">{{ "YES"|_ }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group managed text-field url-field tel-field email-field password-field">
                        <label class="control-label col-sm-3" for="pattern">{{ "Pattern"|_ }}</label>
                        <div class="col-sm-5"><input type="text" name="pattern" id="pattern" class="form-control" value=""/></div>
                        <label class="control-label col-sm-2" for="autocomplete">{{ "Autocomplete"|_ }}</label>
                        <div class="col-sm-2">
                            <select id="autocomplete" name="autocomplete" class="form-control valid">
                                <option value="0">{{ "no"|_ }}</option>
                                <option value="1">{{ "YES"|_ }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group validation -rte-field -hidden-field -select-field -select-multi-field
                            -radio-field -checkbox-field">
                        <label class="control-label col-sm-3" for="validation">{{ "Validation"|_ }}</label>
                        <div class="col-sm-9">
                            <input type="text" name="validation" id="validation" value="" class="form-control">
                        </div>
                    </div>

                </div>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-primary save' type='button'>{{ "Add Field"|_ }}</button>
                <button class='btn btn-default f-grid-modal-close' data-dismiss='modal' type='button'>{{ "Cancel"|_ }}</button>
            </div>
        </div>
        <script type="text/javascript">
            //todo add select2
            require(['jquery', 'select2'], function ($) {
                var $inputType = $("#input_type");
                var lastFieldType;
                $(".managed").hide();
                $('select', "#frontend-field-grid-modal").select2();

                function toggleFields($selector) {
                    var opt = $selector.val();
                    if (lastFieldType != undefined) {
                        var $lastField = $(".-" + lastFieldType + '-field');
                        $lastField.show();
                        $lastField.find("input, select, textarea").prop('disabled', false);
                    }
                    var $managed = $(".managed");
                    $managed.hide();
                    $managed.find("input, select, textarea").prop('disabled', true);
                    if (opt != '-') {
                        var $enable = $("." + opt + '-field');
                        $enable.show();
                        var $inputs = $enable.find("input, select, textarea");
                        $inputs.prop('disabled', false);
                        var $disable = $(".-" + opt + '-field');
                        $disable.hide();
                        $disable.find("input, select, textarea").prop('disabled', true);
                        lastFieldType = opt;
                    }
                }

                $("#options").select2({ // enable comma separated list of values with select2
                    tags:[],
                    tokenSeparators:[',']
                });

                toggleFields($inputType);
                $inputType.change(function(e){
                    e.stopPropagation();
                    toggleFields($inputType);
                });
            });
        </script>
    </div>
</div>
